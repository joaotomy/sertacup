@model List<SertaCup_site.Models.LiveModel>

@{
    ViewData["Title"] = "Início";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Styles {
    <link rel="stylesheet" href="~/css/index.css" />
}

<section class="hero">
    <div class="hero-overlay"></div>
    <div class="grid-container">
        <div class="col-span-4 col-start-1 hero-cup-wrapper">
            <img src="/images/cup test.png" alt="Taça Sertã Cup" class="hero-cup-img" />
        </div>
        <div class="col-span-6 col-start-6 md:col-span-5 md:col-start-4 sm:col-span-4 sm:col-start-1 hero-text">
            <div class="hero-title">IV SERTÃ CUP</div>
            <div class="hero-subtitle">28/29 JUNHO</div>
            <div class="cta-wrapper">
                <a class="cta" asp-controller="Home" asp-action="Informacoes">MAIS INFORMAÇÕES</a>
            </div>
        </div>
    </div>
</section>


<!-- Live Games Section -->
<section class="live-banner">
    <div class="live-strip">ACOMPANHA OS RESULTADOS EM DIRETO!</div>
    <div class="col-span-12 live-grid">
        @{
            var now = DateTime.Now;
            var jogosComData = new List<KeyValuePair<LiveModel, DateTime>>();

            foreach (var j in Model)
            {
                if (DateTime.TryParse(j.Hora, out var parsed))
                {
                    jogosComData.Add(new KeyValuePair<LiveModel, DateTime>(j, parsed));
                }
            }

            var groupedByDay = jogosComData
            .GroupBy(j => j.Value.Date)
            .OrderBy(g => g.Key)
            .ToList();

            List<KeyValuePair<LiveModel, DateTime>> jogosDiaSelecionado = null;

            // Find today’s group with live/upcoming games
            foreach (var group in groupedByDay)
            {
                if (group.Key == now.Date && group.Any(g => g.Value >= now.AddMinutes(-50)))
                {
                    jogosDiaSelecionado = group.ToList();
                    break;
                }
            }

            // Otherwise, pick the next closest day with games
            if (jogosDiaSelecionado == null)
            {
                jogosDiaSelecionado = groupedByDay.FirstOrDefault(g => g.Key > now.Date)?.ToList()
                ?? new List<KeyValuePair<LiveModel, DateTime>>();
            }

            var aoVivo = jogosComData
            .Where(pair => now >= pair.Value && now < pair.Value.AddMinutes(50))
            .OrderBy(pair => pair.Value)
            .Take(8)
            .ToList();

            var proximos = jogosComData
            .Where(pair => pair.Value > now)
            .OrderBy(pair => pair.Value)
            .Take(8 - aoVivo.Count)
            .ToList();

            var jogosParaMostrar = aoVivo.Concat(proximos).Take(8);
        }

        @foreach (var jogoPair in jogosParaMostrar)
        {
            var jogo = jogoPair.Key;
            var dataHora = jogoPair.Value;
            var fase = jogo.grupo == "0" ? "FASE FINAL" : "GRUPO " + jogo.grupo;

            var isLive = jogo.Estado is "1ªP" or "2ªP" or "INTERVALO" or "ATRASADO";
            var isFinal = jogo.Estado == "Resultado Final";
            var isUpcoming = !isLive && !isFinal;

            var displayStatus = isFinal ? "Resultado Final" :
            isLive ? jogo.Estado :
            dataHora.ToString("HH:mm");

            var g1 = int.TryParse(jogo.golos_equipa1, out var golos1) ? golos1 : 0;
            var g2 = int.TryParse(jogo.golos_equipa2, out var golos2) ? golos2 : 0;

            var class1 = isFinal ? (g1 > g2 ? "winner" : g1 < g2 ? "loser" : "") : "";
            var class2 = isFinal ? (g2 > g1 ? "winner" : g2 < g1 ? "loser" : "") : "";

            var sanitized1 = Uri.EscapeDataString(jogo.equipa1 ?? "").ToLower().Replace(" ", "-");
            var sanitized2 = Uri.EscapeDataString(jogo.equipa2 ?? "").ToLower().Replace(" ", "-");



            <div class="live-card">
                <div class="game-caption">
                    <span class="left group">@fase</span>
                    @{
                        var clockClass = isFinal ? "final"
                        : jogo.Estado == "INTERVALO" ? "intervalo"
                        : isUpcoming ? "future"
                        : "";
                    }

                    <span class="right">
                        <span class="phase">
                            @if (isLive)
                            {
                                <span class="live-dot"></span>
                            }
                            <span class="clock @clockClass">@displayStatus</span>
                        </span>
                    </span>
                </div>
                <div class="game-box">
                    <div class="team-block @class1">
                        <img src="/images/teams/@(sanitized1 + ".png")" alt="@jogo.equipa1" class="team-logo" />
                        <span class="team-name"><span>@jogo.equipa1</span></span>
                        <div class="separator"></div>
                        <span class="team-score">@jogo.golos_equipa1</span>
                    </div>
                    <div class="team-block @class2">
                        <img src="/images/teams/@(sanitized2 + ".png")" alt="@jogo.equipa2" class="team-logo" />
                        <span class="team-name"><span>@jogo.equipa2</span></span>
                        <div class="separator"></div>
                        <span class="team-score">@jogo.golos_equipa2</span>
                    </div>
                </div>
            </div>
        }
    </div>
</section>



<!-- Blank Section 1 -->
<section class="blank-section"></section>

@{
    var logoCount = 6;
}

<!-- Patron Banner -->
<section class="patron-banner">
    <div class="logos-wrapper">
        <div class="logos-track" id="logosTrack">
            @for (int i = 1; i <= logoCount; i++)
            {
                <div class="logo-slot">
                    <img src="@($"/images/patron/{i}.png")" alt="Logo @i" />
                </div>
            }
        </div>
        <div class="logos-track clone">
            @for (int i = 1; i <= logoCount; i++)
            {
                <div class="logo-slot">
                    <img src="@($"/images/patron/{i}.png")" alt="Logo @i" />
                </div>
            }
        </div>
    </div>
</section>

<!-- Blank Section 2 -->
<section class="blank-section"></section>

<script src="~/js/index.js"></script>
